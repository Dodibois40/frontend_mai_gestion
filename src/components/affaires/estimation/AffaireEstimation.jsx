import React, { useState, useEffect } from 'react';
import { 
  IconDeviceFloppy, 
  IconRefresh,
  IconChartBar,
  IconUsers,
  IconTruckDelivery
} from '@tabler/icons-react';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import EstimationCartouche from './EstimationCartouche';
import BlocMontant from './blocs/BlocMontant';
import BlocTemps from './blocs/BlocTemps';
import CamembertEstimation from './blocs/CamembertEstimation';
import BlocEquipe from './blocs/BlocEquipe';
import BlocAchats from './blocs/BlocAchats';
import BlocAffectations from './blocs/BlocAffectations';

import { getCouleursAffaire } from './utils/couleursPastel';
import { getEstimationAffaire } from './utils/planningSync';
import * as estimationService from '../../../services/estimationReelService';
import { affairesService } from '../../../services/affairesService';

/**
 * Composant Principal - Estimation Affaires
 * Assemblage de tous les blocs d'estimation avec design Apple
 */
const AffaireEstimation = ({ affaire, onEstimationSave, onEstimationReset }) => {
  const [estimation, setEstimation] = useState({
    montantDevis: 0,
    dateDebut: '',
    dateFin: '',
    totalDemiJournees: 0,
    nombrePersonnes: 2,
    nombreSousTraitants: 0,
    montantAchats: 0,
    montantMainOeuvre: 0,
    montantMainOeuvreCout: 0,
    montantMainOeuvreVente: 0,
    montantMainOeuvreGain: 0,
    montantFraisGeneraux: 0,
    montantMarge: 0,
    tauxHoraireCout: 25,
    tauxHoraireVente: 75
  });
  
  const [isSaving, setIsSaving] = useState(false);
  const [hasChanges, setHasChanges] = useState(false);
  const [couleurAffaire, setCouleurAffaire] = useState(null);
  const [lastSaved, setLastSaved] = useState(null);
  const [affectationsDetectees, setAffectationsDetectees] = useState([]);
  const [dateSurvolee, setDateSurvolee] = useState(null);
  const [affectationsJourSurvole, setAffectationsJourSurvole] = useState([]);
  const [justReset, setJustReset] = useState(false); // üîí Flag pour emp√™cher le rechargement apr√®s reset
  const [resetTrigger, setResetTrigger] = useState(0); // üîÑ Trigger pour forcer la r√©initialisation du calendrier
  const [isSelectingDates, setIsSelectingDates] = useState(false); // üîí Flag pour emp√™cher rechargement pendant s√©lection
  const [justSaved, setJustSaved] = useState(false); // üîí Flag pour emp√™cher rechargement apr√®s sauvegarde
  
  // üåü √âtats de progression intelligente
  const [hasMontantValide, setHasMontantValide] = useState(false);
  const [hasPlanningComplete, setHasPlanningComplete] = useState(false);
  
  // Charger l'estimation existante
  useEffect(() => {
    // üîÑ NOUVELLE CORRECTION : Nettoyer TOUTES les sources de persistance au changement d'affaire
    console.log('üßπ CHANGEMENT D\'AFFAIRE - Nettoyage complet des caches:', affaire.id);
    
    // Nettoyer le cache en m√©moire (window.planningEstimations)
    if (window.planningEstimations && window.planningEstimations.has(affaire.id)) {
      window.planningEstimations.delete(affaire.id);
      console.log('üßπ Cache m√©moire nettoy√© pour affaire:', affaire.id);
    }
    
    // Nettoyer localStorage
    try {
      localStorage.removeItem(`estimation_${affaire.id}`);
      console.log('üßπ LocalStorage nettoy√© pour affaire:', affaire.id);
    } catch (error) {
      // Ignore les erreurs localStorage
    }
    
    // R√©initialiser l'estimation locale AVANT de charger
    setEstimation({
      montantDevis: 0,
      dateDebut: '',
      dateFin: '',
      totalDemiJournees: 0,
      nombrePersonnes: 2,
      nombreSousTraitants: 0,
      montantAchats: 0,
      montantMainOeuvre: 0,
      montantMainOeuvreCout: 0,
      montantMainOeuvreVente: 0,
      montantMainOeuvreGain: 0,
      montantFraisGeneraux: 0,
      montantMarge: 0,
      tauxHoraireCout: 25,
      tauxHoraireVente: 75
    });
    
    // Forcer la r√©initialisation du calendrier
    setResetTrigger(prev => prev + 1);
    
    // Charger l'estimation depuis l'API seulement apr√®s nettoyage
    setTimeout(() => {
      if (!isSelectingDates) {
        chargerEstimationExistante();
      }
    }, 100);
    
    // Obtenir la couleur de l'affaire
    const couleurs = getCouleursAffaire(affaire.id);
    setCouleurAffaire(couleurs);
  }, [affaire.id]); // Simplification des d√©pendances
  
  // üîí G√©rer le flag justReset s√©par√©ment
  useEffect(() => {
    if (justReset) {
      // Remettre le flag √† false apr√®s un d√©lai tr√®s court
      const timer = setTimeout(() => {
        setJustReset(false);
      }, 500); // 500ms seulement - plus permissif
      
      return () => clearTimeout(timer);
    }
  }, [justReset]);

  // üîí G√©rer le flag justSaved s√©par√©ment
  useEffect(() => {
    if (justSaved) {
      // Remettre le flag √† false apr√®s un d√©lai tr√®s court
      const timer = setTimeout(() => {
        setJustSaved(false);
      }, 300); // 300ms seulement - tr√®s permissif
      
      return () => clearTimeout(timer);
    }
  }, [justSaved]);

  // üîí Emp√™cher le rechargement automatique pendant la s√©lection
  useEffect(() => {
    if (isSelectingDates) {
      // Annuler tous les timeouts de sauvegarde pendant la s√©lection
      if (window.autoSaveTimeout) {
        clearTimeout(window.autoSaveTimeout);
        window.autoSaveTimeout = null;
      }
      
      // D√©sactiver automatiquement apr√®s un d√©lai court
      const timer = setTimeout(() => {
        setIsSelectingDates(false);
      }, 2000); // 2 secondes max
      
      return () => clearTimeout(timer);
    }
  }, [isSelectingDates]);
  

  
  // üåü Logique de progression intelligente
  useEffect(() => {
    // √âtape 1 : Validation du montant
    const montantEstValide = estimation.montantDevis > 0;
    setHasMontantValide(montantEstValide);
    
    // √âtape 2 : Planning complet (dates renseign√©es) - V√©rifier les deux formats de dates
    const dateDebut = estimation.dateDebut || estimation.dateCommencement;
    const dateFin = estimation.dateFin || estimation.dateReception;
    const planningComplet = montantEstValide && dateDebut && dateFin;
    setHasPlanningComplete(planningComplet);
  }, [estimation.montantDevis, estimation.dateDebut, estimation.dateFin, estimation.dateCommencement, estimation.dateReception]);
  
  const chargerEstimationExistante = async () => {
    try {
      // üîÑ CORRECTION : Protection all√©g√©e - seulement pendant s√©lection active
      if (isSelectingDates) {
        return;
      }
      
      // Charger depuis l'API backend
      const estimationsExistantes = await estimationService.getEstimationsByAffaire(affaire.id);
      
      if (estimationsExistantes && estimationsExistantes.length > 0) {
        const estimationApi = estimationsExistantes[0];
        
        // Convertir les donn√©es API vers le format du composant
        const estimationConvertie = {
          montantDevis: estimationApi.montantTotalEstime || 0,
          dateDebut: estimationApi.dateCommencementEstimee || '',
          dateFin: estimationApi.dateReceptionEstimee || '',
          totalDemiJournees: estimationApi.dureeTotaleEstimee || 0,
          nombrePersonnes: estimationApi.nombrePersonnesEstime || 2,
          nombreSousTraitants: estimationApi.nombreSousTraitants || 0,
          montantAchats: estimationApi.coutAchatsEstime || 0,
          montantMainOeuvre: estimationApi.coutMainOeuvreEstime || 0,
          montantMainOeuvreCout: estimationApi.coutMainOeuvreEstime || 0,
          montantMainOeuvreVente: estimationApi.montantMainOeuvreVente || 0,
          montantMainOeuvreGain: estimationApi.montantMainOeuvreGain || 0,
          montantFraisGeneraux: estimationApi.coutFraisGenerauxEstime || 0,
          montantMarge: estimationApi.margeEstimee || 0,
          // üîß CORRECTION : Inclure les propri√©t√©s sp√©cifiques aux blocs
          demiJourneesFabrication: estimationApi.demiJourneesFabricationEstimees || 0,
          demiJourneesPose: estimationApi.demiJourneesPoseEstimees || 0,
          tauxHoraire: estimationApi.tauxHoraireMoyenEstime || 25,
          tauxHoraireCout: estimationApi.tauxHoraireMoyenEstime || 25,
          tauxHoraireVente: estimationApi.tauxHoraireVente || 75,
          // Propri√©t√©s calcul√©es pour les blocs
          dateCommencement: estimationApi.dateCommencementEstimee || '',
          dateReception: estimationApi.dateReceptionEstimee || '',
          // Conserver les propri√©t√©s √©tendues si elles existent
          categoriesAchats: estimationApi.categoriesAchats || [],
          repartitionAchats: estimationApi.repartitionAchats || {},
          repartitionFabrication: estimationApi.repartitionFabrication || 60,
          repartitionPose: estimationApi.repartitionPose || 40
        };
        
        // üîÑ CORRECTION : Chargement conditionnel plus permissif
        if (!isSelectingDates) {
          setEstimation(prevEstimation => ({
            ...prevEstimation, // Conserver les donn√©es existantes
            ...estimationConvertie, // Appliquer les nouvelles donn√©es
            // üîß PR√âSERVER sp√©cifiquement les donn√©es de l'√©quipe si elles existent d√©j√†
            demiJourneesFabrication: estimationConvertie.demiJourneesFabricationEstimees || prevEstimation.demiJourneesFabrication || 0,
            demiJourneesPose: estimationConvertie.demiJourneesPoseEstimees || prevEstimation.demiJourneesPose || 0,
            nombrePersonnes: estimationConvertie.nombrePersonnesEstime || prevEstimation.nombrePersonnes || 2,
            tauxHoraire: estimationConvertie.tauxHoraireMoyenEstime || prevEstimation.tauxHoraire || 75,
            repartitionFabrication: estimationConvertie.repartitionFabrication || prevEstimation.repartitionFabrication || 60,
            repartitionPose: estimationConvertie.repartitionPose || prevEstimation.repartitionPose || 40
          }));
        }
      } else {
        // Fallback vers le stockage local si aucune estimation en base
        const estimationLocale = getEstimationAffaire(affaire.id);
        if (estimationLocale && !isSelectingDates) {
          setEstimation(prevEstimation => ({
            ...prevEstimation, // Conserver les donn√©es existantes
            ...estimationLocale // Appliquer les donn√©es locales
          }));
        }
      }
    } catch (error) {
      console.error('‚ùå Erreur chargement estimation depuis l\'API:', error);
      // Fallback vers le stockage local en cas d'erreur
      try {
        const estimationLocale = getEstimationAffaire(affaire.id);
        if (estimationLocale && !isSelectingDates) {
          setEstimation(prevEstimation => ({
            ...prevEstimation, // Conserver les donn√©es existantes
            ...estimationLocale // Appliquer les donn√©es locales
          }));
        }
      } catch (fallbackError) {
        console.error('‚ùå Erreur fallback estimation:', fallbackError);
      }
    }
  };
  

  
  const handleEstimationChange = (nouvelleEstimation) => {
    console.log('üîÑ Changement d√©tect√© dans l\'estimation:', nouvelleEstimation);
    
    // Cr√©er une copie mutable pour √©viter l'erreur "Assignment to constant variable"
    let estimationMiseAJour = { ...estimation, ...nouvelleEstimation };
    
    // DEBUG
    console.log('üîç DEBUG AffaireEstimation - handleEstimationChange:', {
      recalculerRepartition: estimationMiseAJour.recalculerRepartition,
      montantDevis: estimationMiseAJour.montantDevis,
      montantAchats: estimationMiseAJour.montantAchats,
      montantMainOeuvre: estimationMiseAJour.montantMainOeuvre,
      montantFraisGeneraux: estimationMiseAJour.montantFraisGeneraux,
      montantMarge: estimationMiseAJour.montantMarge
    });
    
    // üí∞ NOUVEAU : Recalculer la r√©partition financi√®re si demand√©
    if (estimationMiseAJour.recalculerRepartition && estimationMiseAJour.montantDevis > 0) {
      console.log('üí∞ Recalcul de la r√©partition financi√®re demand√©');
      
      const montantDevis = estimationMiseAJour.montantDevis;
      const montantMainOeuvre = estimationMiseAJour.montantMainOeuvreCout || estimationMiseAJour.montantMainOeuvre || 0;
      
      // üî• NOUVEAU : Achats par d√©faut √† 20% du devis
      let montantAchats = estimationMiseAJour.montantAchats || Math.round(montantDevis * 0.2);
      
      // üî• NOUVEAU : Frais g√©n√©raux TOUJOURS √† 30% du devis
      let montantFraisGeneraux = Math.round(montantDevis * 0.3);
      
      // Calculer la marge comme le reste apr√®s main d'≈ìuvre, achats et frais g√©n√©raux
      let montantMarge = montantDevis - montantMainOeuvre - montantAchats - montantFraisGeneraux;
      
      // Si la marge devient n√©gative, ajuster la r√©partition
      if (montantMarge < 0) {
        // Calculer ce qui reste apr√®s la main d'≈ìuvre
        const resteApresMO = montantDevis - montantMainOeuvre;
        
        if (resteApresMO > 0) {
          // R√©partir le reste entre achats (20%), frais g√©n√©raux (30%) et marge (le reste)
          // Si pas assez de place, prioriser dans l'ordre : achats, frais g√©n√©raux, marge
          if (resteApresMO >= montantAchats + montantFraisGeneraux) {
            // Cas normal : il y a de la place pour achats + frais g√©n√©raux
            montantMarge = resteApresMO - montantAchats - montantFraisGeneraux;
          } else if (resteApresMO >= montantAchats) {
            // Pas assez pour les frais g√©n√©raux complets
            montantFraisGeneraux = resteApresMO - montantAchats;
            montantMarge = 0;
          } else {
            // M√™me pas assez pour les achats complets
            montantAchats = resteApresMO;
            montantFraisGeneraux = 0;
            montantMarge = 0;
          }
        } else {
          // La main d'≈ìuvre d√©passe le devis
          montantAchats = 0;
          montantFraisGeneraux = 0;
          montantMarge = 0;
        }
      }
      
      // Calculer les pourcentages r√©els
      const pourcentageMainOeuvre = montantDevis > 0 ? Math.round((montantMainOeuvre / montantDevis) * 100) : 0;
      const pourcentageAchats = montantDevis > 0 ? Math.round((montantAchats / montantDevis) * 100) : 0;
      const pourcentageFraisGeneraux = montantDevis > 0 ? Math.round((montantFraisGeneraux / montantDevis) * 100) : 0;
      const pourcentageMarge = montantDevis > 0 ? Math.round((montantMarge / montantDevis) * 100) : 0;
      
      console.log('üí∞ Nouvelle r√©partition:', {
        montantDevis,
        montantMainOeuvre: `${montantMainOeuvre}‚Ç¨ (${pourcentageMainOeuvre}%)`,
        montantAchats: `${montantAchats}‚Ç¨ (${pourcentageAchats}%)`,
        montantFraisGeneraux: `${montantFraisGeneraux}‚Ç¨ (${pourcentageFraisGeneraux}%)`,
        montantMarge: `${montantMarge}‚Ç¨ (${pourcentageMarge}%)`
      });
      
      // Mise √† jour avec la nouvelle r√©partition
      estimationMiseAJour = {
        ...estimationMiseAJour,
        montantAchats,
        montantMainOeuvre,
        montantFraisGeneraux,
        montantMarge,
        pourcentages: {
          achats: pourcentageAchats,
          mainOeuvre: pourcentageMainOeuvre,
          fraisGeneraux: pourcentageFraisGeneraux,
          marge: pourcentageMarge
        },
        // üí∞ NOUVEAU : Ajouter les montants d√©taill√©s de main d'≈ìuvre
        montantMainOeuvreCout: montantMainOeuvre,
        montantMainOeuvreVente: estimationMiseAJour.montantMainOeuvreVente || montantMainOeuvre * 3,
        montantMainOeuvreGain: estimationMiseAJour.montantMainOeuvreGain || montantMainOeuvre * 2
      };
      
      // Plus besoin de recalculer
      delete estimationMiseAJour.recalculerRepartition;
    }
    
    // üöÄ SYNC : Utiliser l'√©tat local
    setEstimation(estimationMiseAJour);
    setHasChanges(true);
    
    // üîÑ CORRECTION : Protection l√©g√®re seulement pour les changements de dates
    if (estimationMiseAJour.dateDebut || estimationMiseAJour.dateFin) {
      setIsSelectingDates(true);
      // D√©sactiver apr√®s un d√©lai tr√®s court
      setTimeout(() => {
        setIsSelectingDates(false);
      }, 500); // 500ms seulement
    }
    
    // üö´ D√âSACTIVER COMPL√àTEMENT LA SAUVEGARDE AUTOMATIQUE
    // La sauvegarde automatique cause des conflits avec les modifications utilisateur
    // SEULE la sauvegarde manuelle est autoris√©e
    
    // üîß Nettoyer tout timeout existant
    if (window.autoSaveTimeout) {
      clearTimeout(window.autoSaveTimeout);
      window.autoSaveTimeout = null;
    }
  };
  
  // üö´ SUPPRIMER COMPL√àTEMENT LA SAUVEGARDE AUTOMATIQUE
  // Cette fonction n'est plus utilis√©e pour √©viter les conflits
  
  const handleSauvegarder = async () => {
    if (!estimation.montantDevis || estimation.montantDevis <= 0) {
      alert('Veuillez saisir un montant valide avant de sauvegarder');
      return;
    }
    
    // üîß PROTECTION : Emp√™cher les sauvegardes multiples simultan√©es
    if (isSaving) {
      console.log('üîí Sauvegarde d√©j√† en cours, ignor√©e');
      return;
    }
    
    setIsSaving(true);
    
    try {
      // üîß NETTOYER tout timeout de sauvegarde automatique
      if (window.autoSaveTimeout) {
        clearTimeout(window.autoSaveTimeout);
        window.autoSaveTimeout = null;
      }
      
      // Pr√©parer les donn√©es pour sauvegarde
      const estimationComplete = {
        ...estimation,
        affaireId: affaire.id,
        affaireNumero: affaire.numero,
        affaireClient: affaire.client,
        couleurPastel: couleurAffaire?.pastel,
        couleurBordure: couleurAffaire?.bordure,
        dateCreation: new Date().toISOString(),
        version: '1.0'
      };
      
      console.log('üíæ SAUVEGARDE MANUELLE UNIQUE:', estimationComplete);
      console.log('üîç DEBUG - √âtat estimation actuel:', {
        montantDevis: estimation.montantDevis,
        montantAchats: estimation.montantAchats,
        montantMainOeuvre: estimation.montantMainOeuvre,
        montantMainOeuvreCout: estimation.montantMainOeuvreCout,
        montantFraisGeneraux: estimation.montantFraisGeneraux,
        montantMarge: estimation.montantMarge,
        totalDemiJournees: estimation.totalDemiJournees
      });
      
      // Sauvegarder via le callback parent
      if (onEstimationSave) {
        await onEstimationSave(estimationComplete);
      }
      
      // üî• NOUVEAU : √âmettre un √©v√©nement pour notifier le parent
      window.dispatchEvent(new CustomEvent('estimation_updated', { 
        detail: { affaireId: affaire.id } 
      }));
      
      // ‚úÖ Marquer comme sauvegard√© (l'appel √† onEstimationSave a d√©j√† √©t√© fait ligne 432)
      setLastSaved(new Date());
      setJustSaved(true); // üîí Activer le flag apr√®s sauvegarde
      
      console.log('‚úÖ SAUVEGARDE TERMIN√âE - Modifications futures autoris√©es');
      
    } catch (error) {
      console.error('‚ùå Erreur sauvegarde:', error);
      alert('Erreur lors de la sauvegarde. Veuillez r√©essayer.');
    } finally {
      setIsSaving(false);
      // üîß PAS DE FLAG DE PROTECTION - Autoriser modifications imm√©diates
    }
  };
  
  const handleReset = async () => {
    if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser l\'estimation ?\n\nCette action supprimera :\n- L\'estimation intelligente\n- Les objectifs de l\'affaire (CA, achats, heures...)\n- Les affectations planning associ√©es\n- Toutes les donn√©es en cache')) {
      console.log('üîÑ D√âBUT R√âINITIALISATION COMPL√àTE');
      
      // üõë Annuler la sauvegarde automatique en cours
      if (window.autoSaveTimeout) {
        clearTimeout(window.autoSaveTimeout);
        window.autoSaveTimeout = null;
      }
      
      // üóëÔ∏è √âTAPE 1 : Nettoyer TOUTES les sources de donn√©es
      try {
        // Supprimer de l'API
        await estimationService.deleteEstimationsByAffaire(affaire.id);
        console.log('üßπ Base de donn√©es nettoy√©e');
        
        // üÜï √âTAPE 1.5 : Supprimer les affectations du planning pour cette affaire
        try {
          const { default: planningEquipeService } = await import('../../../services/planningEquipeService');
          await planningEquipeService.supprimerAffectationsAffaire(affaire.id);
          console.log('üßπ Affectations planning supprim√©es');
        } catch (planningError) {
          console.warn('‚ö†Ô∏è Erreur lors de la suppression des affectations planning:', planningError);
        }
        
        // üî• NOUVEAU : Remettre √† z√©ro les objectifs de l'affaire
        try {
          console.log('üîÑ Tentative de mise √† jour des objectifs pour affaire:', affaire.id);
          const updateData = {
            objectifCaHt: 0,
            objectifAchatHt: 0,
            objectifHeuresFab: 0,
            objectifHeuresSer: 0,
            objectifHeuresPose: 0,
            objectifFraisGeneraux: 0,
            dateCommencement: null,
            dateCloturePrevue: null
          };
          console.log('üìä Donn√©es √† envoyer:', updateData);
          
          const result = await affairesService.updateAffaire(affaire.id, updateData);
          console.log('‚úÖ R√©sultat de la mise √† jour:', result);
          console.log('üßπ Objectifs de l\'affaire remis √† z√©ro avec succ√®s');
        } catch (updateError) {
          console.error('‚ùå ERREUR D√âTAILL√âE lors de la mise √† jour des objectifs:', updateError);
          console.error('‚ùå Message:', updateError.message);
          console.error('‚ùå Stack:', updateError.stack);
          console.error('‚ùå Response:', updateError.response);
          
          // Afficher une alerte √† l'utilisateur
          alert(`Erreur lors de la remise √† z√©ro des objectifs: ${updateError.message || 'Erreur inconnue'}`);
        }
        
        // Nettoyer le cache en m√©moire (window.planningEstimations)
        if (window.planningEstimations && window.planningEstimations.has(affaire.id)) {
          window.planningEstimations.delete(affaire.id);
          console.log('üßπ Cache m√©moire nettoy√©');
        }
        
        // Nettoyer localStorage
        try {
          localStorage.removeItem(`estimation_${affaire.id}`);
          console.log('üßπ LocalStorage nettoy√©');
        } catch (localError) {
          // Stockage local non accessible
        }
        
        // üÜï Nettoyer la synchronisation planning
        try {
          const { clearPlanningEstimation } = await import('./utils/planningSync');
          clearPlanningEstimation(affaire.id);
          console.log('üßπ Synchronisation planning nettoy√©e');
        } catch (syncError) {
          console.warn('‚ö†Ô∏è Erreur lors du nettoyage de la synchronisation:', syncError);
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Erreur lors de la suppression:', error);
        // Continuer malgr√© l'erreur pour au moins r√©initialiser localement
      }
      
      // üîÑ √âTAPE 2 : R√©initialiser l'estimation locale
      const estimationVide = {
        montantDevis: 0,
        dateDebut: '',
        dateFin: '',
        totalDemiJournees: 0,
        nombrePersonnes: 2,
        montantAchats: 0,
        montantMainOeuvre: 0,
        montantFraisGeneraux: 0,
        montantMarge: 0,
        // üÜï R√©initialiser aussi les propri√©t√©s √©tendues
        demiJourneesFabrication: 0,
        demiJourneesPose: 0,
        tauxHoraire: 75,
        dateCommencement: '',
        dateReception: '',
        categoriesAchats: [],
        repartitionAchats: {},
        repartitionFabrication: 60,
        repartitionPose: 40
      };
      
      setEstimation(estimationVide);
      
      // üßπ √âTAPE 3 : Nettoyer tous les √©tats associ√©s
      setHasChanges(false);
      setAffectationsDetectees([]);
      setDateSurvolee(null);
      setAffectationsJourSurvole([]);
      setLastSaved(null);
      setHasMontantValide(false);
      setHasPlanningComplete(false);
      
      // üîÑ √âTAPE 4 : D√©clencher la r√©initialisation forc√©e du calendrier
      setResetTrigger(prev => prev + 1);
      
      // üÜï √âTAPE 5 : Forcer le rechargement du calendrier apr√®s un d√©lai
      setTimeout(() => {
        setResetTrigger(prev => prev + 1);
      }, 300);
      
      // üî• NOUVEAU : √âmettre un √©v√©nement pour notifier le parent
      window.dispatchEvent(new CustomEvent('estimation_reset', { 
        detail: { affaireId: affaire.id } 
      }));
      
      console.log('‚úÖ R√âINITIALISATION COMPL√àTE TERMIN√âE');
      
      // üÜï Notification visuelle
      alert('‚úÖ Estimation r√©initialis√©e avec succ√®s !\n\n- Donn√©es supprim√©es de la base\n- Objectifs de l\'affaire remis √† z√©ro\n- Affectations planning nettoy√©es\n- Caches vid√©s');
      
      // üîÑ NOUVEAU : Rafra√Æchir les donn√©es financi√®res apr√®s r√©initialisation
      if (onEstimationReset) {
        onEstimationReset();
      }
      
      // üî• FORCER LE RECHARGEMENT DE LA PAGE pour garantir la mise √† jour
      setTimeout(() => {
        window.location.reload();
      }, 500);
    }
  };
  
  const isEstimationComplete = estimation.montantDevis > 0 && estimation.dateDebut && estimation.dateFin;
  
  return (
    <div className="affaire-estimation space-y-6 p-6 bg-white min-h-screen">
      {/* üé® Cartouche principal */}
      <EstimationCartouche 
        affaire={affaire}
        onEstimationChange={handleEstimationChange}
      />
      
      {/* üìä Barre d'√©tat */}
      <Card className="bg-white border-gray-200 shadow-sm">
        <CardContent className="p-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              {/* üåü Indicateur de progression intelligente */}
              <div className="flex items-center gap-2">
                <Badge 
                  variant={hasMontantValide ? "default" : "secondary"}
                  className={hasMontantValide ? "bg-blue-100 text-blue-800" : ""}
                >
                  {hasMontantValide ? "1Ô∏è‚É£ Montant ‚úÖ" : "1Ô∏è‚É£ Montant ‚è≥"}
                </Badge>
                <span className="text-gray-400">‚Üí</span>
                <Badge 
                  variant={hasPlanningComplete ? "default" : "secondary"}
                  className={hasPlanningComplete ? "bg-purple-100 text-purple-800" : ""}
                >
                  {hasPlanningComplete ? "2Ô∏è‚É£ Planning ‚úÖ" : "2Ô∏è‚É£ Planning ‚è≥"}
                </Badge>
                <span className="text-gray-400">‚Üí</span>
                <Badge 
                  variant={isEstimationComplete ? "default" : "secondary"}
                  className={isEstimationComplete ? "bg-green-100 text-green-800" : ""}
                >
                  {isEstimationComplete ? "3Ô∏è‚É£ Calculs ‚úÖ" : "3Ô∏è‚É£ Calculs ‚è≥"}
                </Badge>
              </div>
              
              {estimation.montantDevis > 0 && (
                <Badge variant="outline" className="text-blue-600">
                  <IconChartBar className="w-4 h-4 mr-1" />
                  {estimation.montantDevis.toLocaleString()}‚Ç¨
                </Badge>
              )}
              
              {estimation.totalDemiJournees > 0 && (
                <Badge variant="outline" className="text-purple-600">
                  <IconUsers className="w-4 h-4 mr-1" />
                  {estimation.totalDemiJournees} demi-j
                </Badge>
              )}
              
              {couleurAffaire && (
                <div className="flex items-center gap-2">
                  <div 
                    className="w-4 h-4 rounded-full border"
                    style={{ 
                      backgroundColor: couleurAffaire.pastel,
                      borderColor: couleurAffaire.bordure
                    }}
                  />
                  <span className="text-sm text-gray-600">Planning color√©</span>
                </div>
              )}
            </div>
            
            {/* Actions */}
            <div className="flex items-center gap-2">
              {lastSaved && !hasChanges && (
                <Badge variant="secondary" className="text-green-600">
                  <IconDeviceFloppy className="w-4 h-4 mr-1" />
                  Sauvegard√© √† {lastSaved.toLocaleTimeString()}
                </Badge>
              )}
              
              <Button
                variant="outline"
                size="sm"
                onClick={handleReset}
                disabled={isSaving}
              >
                <IconRefresh className="w-4 h-4 mr-2" />
                R√©initialiser
              </Button>
              
              <Button
                onClick={handleSauvegarder}
                disabled={isSaving || !estimation.montantDevis}
                className="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700"
              >
                <IconDeviceFloppy className={`w-4 h-4 mr-2 ${isSaving ? 'animate-spin' : ''}`} />
                {isSaving ? 'Sauvegarde...' : 'Sauvegarder'}
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>
      
      {/* üî• Grille des blocs d'estimation - 4 colonnes pour espace maximal */}
      <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
        {/* üí∞ Colonne 1 - Montant & Affectations */}
        <div className="space-y-6">
          <BlocMontant
            affaire={affaire}
            estimation={estimation}
            onEstimationChange={handleEstimationChange}
          />
          
          {/* üë• Bloc Affectations - Sous le montant */}
          <div className={`relative transition-all duration-500 ${!hasMontantValide ? 'opacity-50 pointer-events-none' : ''}`}>
            <BlocAffectations
              affectations={affectationsJourSurvole}
              dateSurvolee={dateSurvolee}
              disabled={!hasMontantValide}
              onRefresh={() => {
                // D√©clencher le rechargement des affectations via le calendrier
                console.log('üîÑ Rechargement des affectations depuis le bloc d√©di√©');
              }}
            />
            {!hasMontantValide && (
              <div className="absolute inset-0 bg-gray-100 bg-opacity-75 flex items-center justify-center rounded-lg backdrop-blur-sm">
                <div className="text-center text-gray-500">
                  <div className="text-lg font-semibold">üîí Verrouill√©</div>
                  <div className="text-sm">Validez d'abord le montant du devis</div>
                </div>
              </div>
            )}
          </div>
        </div>
        
        {/* üìÖ Colonne 2 - Planning & Temps */}
        <div className="space-y-6">
          {/* üìÖ Bloc Temps - R√©v√©l√© apr√®s validation montant */}
          <div className={`relative transition-all duration-500 ${!hasMontantValide ? 'opacity-50 pointer-events-none' : ''}`}>
            <BlocTemps
              estimation={estimation}
              onEstimationChange={handleEstimationChange}
              affaire={affaire}
              disabled={!hasMontantValide}
              resetTrigger={resetTrigger}
              onAffectationsChange={setAffectationsDetectees}
              onDateSurvol={(date, affectations) => {
                setDateSurvolee(date);
                setAffectationsJourSurvole(affectations);
              }}
            />
            {!hasMontantValide && (
              <div className="absolute inset-0 bg-gray-100 bg-opacity-75 flex items-center justify-center rounded-lg backdrop-blur-sm">
                <div className="text-center text-gray-500">
                  <div className="text-lg font-semibold">üîí Verrouill√©</div>
                  <div className="text-sm">Validez d'abord le montant du devis</div>
                </div>
              </div>
            )}
          </div>
        </div>
        
        {/* üõ†Ô∏è Colonne 3 - Ressources & Achats */}
        <div className="space-y-6">
          {/* Bloc √âquipe - R√©v√©l√© apr√®s planning complet */}
          <div className={`relative transition-all duration-500 ${!hasPlanningComplete ? 'opacity-50 pointer-events-none' : ''}`}>
            <BlocEquipe 
              estimation={estimation} 
              onEstimationChange={handleEstimationChange}
              disabled={!hasPlanningComplete}
            />
            {!hasPlanningComplete && (
              <div className="absolute inset-0 bg-gray-100 bg-opacity-75 flex items-center justify-center rounded-lg backdrop-blur-sm">
                <div className="text-center text-gray-500">
                  <div className="text-lg font-semibold">üîí Verrouill√©</div>
                  <div className="text-sm">Compl√©tez le planning pour r√©v√©ler les calculs</div>
                </div>
              </div>
            )}
          </div>
          
          {/* Bloc Achats - R√©v√©l√© apr√®s planning complet */}
          <div className={`relative transition-all duration-500 ${!hasPlanningComplete ? 'opacity-50 pointer-events-none' : ''}`}>
            <BlocAchats 
              estimation={estimation} 
              onEstimationChange={handleEstimationChange}
              disabled={!hasPlanningComplete}
              montantDevis={estimation.montantDevis}
            />
            {!hasPlanningComplete && (
              <div className="absolute inset-0 bg-gray-100 bg-opacity-75 flex items-center justify-center rounded-lg backdrop-blur-sm">
                <div className="text-center text-gray-500">
                  <div className="text-lg font-semibold">üîí Verrouill√©</div>
                  <div className="text-sm">Compl√©tez le planning pour r√©v√©ler les calculs</div>
                </div>
              </div>
            )}
          </div>
        </div>
        
        {/* üìä Colonne 4 - Analyses & Graphiques */}
        <div className="space-y-6">
          {/* üìä Camembert de r√©partition */}
          <div className={`relative transition-all duration-500 ${!hasPlanningComplete ? 'opacity-50 pointer-events-none' : ''}`}>
            <CamembertEstimation estimation={estimation} />
            {!hasPlanningComplete && (
              <div className="absolute inset-0 bg-gray-100 bg-opacity-75 flex items-center justify-center rounded-lg backdrop-blur-sm">
                <div className="text-center text-gray-500">
                  <div className="text-lg font-semibold">üîí Verrouill√©</div>
                  <div className="text-sm">Compl√©tez le planning pour r√©v√©ler les calculs</div>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
      
      {/* üéØ R√©sum√© final si estimation compl√®te */}
      {isEstimationComplete && (
        <Card className="bg-gradient-to-br from-green-50 to-emerald-50 border-green-200 shadow-lg">
          <CardContent className="p-6">
            <div className="text-center space-y-4">
              <div className="text-2xl font-bold text-green-900">
                üéâ Estimation Compl√®te
              </div>
              
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div className="text-center">
                  <div className="text-xl font-bold text-green-800">
                    {estimation.montantDevis.toLocaleString()}‚Ç¨
                  </div>
                  <div className="text-sm text-green-600">Montant total</div>
                </div>
                
                <div className="text-center">
                  <div className="text-xl font-bold text-green-800">
                    {estimation.totalDemiJournees || 0}
                  </div>
                  <div className="text-sm text-green-600">Demi-journ√©es</div>
                </div>
                
                <div className="text-center">
                  <div className="text-xl font-bold text-green-800">
                    {new Date(estimation.dateDebut).toLocaleDateString('fr-FR')}
                  </div>
                  <div className="text-sm text-green-600">Date d√©but</div>
                </div>
                
                <div className="text-center">
                  <div className="text-xl font-bold text-green-800">
                    {new Date(estimation.dateFin).toLocaleDateString('fr-FR')}
                  </div>
                  <div className="text-sm text-green-600">Date fin</div>
                </div>
              </div>
              
              <div className="text-sm text-green-600">
                L'estimation est synchronis√©e avec le planning √©quipe
              </div>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
};

export default AffaireEstimation; 